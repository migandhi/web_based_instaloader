import random
import asyncio
import aiohttp
import requests
from flask import Flask, render_template, request, send_file
from itertools import islice
from math import ceil
from instaloader import Instaloader, Profile
import shutil
import os
import zipfile

app = Flask(__name__)

# Define your list of proxies
proxy_list = """
24.52.42.196:80
45.58.52.5:80
93.184.4.254:1080
92.205.108.94:31288
163.172.166.35:16379
94.232.11.178:58028
93.91.148.34:9898
173.212.209.49:26404
202.40.178.34:5678
209.94.84.193:1080
203.161.32.242:54493
104.238.111.107:27241
195.98.74.57:1080
192.111.139.165:4145
49.156.41.179:21
121.52.72.101:18
128.199.196.31:56547
209.198.43.52:5678
203.112.223.126:5678
51.158.77.220:16379
190.145.182.2:4153
201.221.134.74:5678
128.199.104.190:41354
38.145.211.247:8899
159.192.97.129:5678
103.207.96.90:41238
187.252.154.90:4153
103.215.139.32:57421
199.204.248.169:51794
103.234.24.105:8880
5.252.23.220:1080
213.5.197.61:1080
105.214.65.244:5678
176.197.103.58:4145
38.145.211.246:8899
203.161.32.218:59220
203.150.128.89:5678
122.248.46.26:4145
162.55.87.48:5566
159.65.245.255:80
46.253.143.144:1080
103.76.172.230:4153
201.144.20.231:5678
149.130.218.26:80
194.163.159.94:14244
162.243.55.12:59179
92.42.8.23:4153
103.234.27.221:9990
111.68.31.134:40385
43.229.85.48:49665
166.0.235.140:5459
185.220.174.99:59967
157.245.95.247:443
38.180.112.116:80
185.42.228.66:1080
162.241.46.69:52569
194.163.137.106:9050
68.183.104.254:8000
37.1.199.18:80
46.232.248.164:80
192.140.42.83:59057
129.213.150.205:8080
51.68.87.173:29212
178.212.51.166:33333
37.26.86.206:4145
185.78.76.190:1080
103.113.71.230:1080
92.205.110.118:59848
185.226.113.180:38030
20.127.221.223:80
148.113.161.228:8306
5.141.121.142:1080
207.246.105.172:8899
54.36.122.16:25429
188.166.234.144:16813
38.133.200.94:31596
82.97.215.240:80
178.62.7.98:32803
115.72.174.81:41710
36.91.45.12:51299
178.217.168.164:55443
54.38.179.162:58654
163.172.165.36:16379
50.63.12.33:57800
79.7.101.98:5678
103.68.3.114:4145
85.228.43.192:4153
213.149.156.87:5678
139.162.60.36:45701
5.59.141.94:1080
47.206.214.4:54321
103.154.112.34:35010
171.244.140.160:7283
115.127.2.230:5678
138.197.81.54:3128
72.195.101.99:4145
103.174.178.137:2016
183.100.14.134:8000
51.158.119.71:16379
91.65.102.60:80
192.163.201.131:53651
149.56.147.81:8306
41.47.65.182:80
12.133.53.17:83
46.47.197.210:3128
61.110.5.2:80
35.225.16.82:2387
181.65.200.53:80
164.92.237.188:52858
130.255.162.54:24055
104.36.166.42:4269
79.98.1.32:34746
193.30.13.18:999
103.112.162.241:5678
83.151.4.172:47036
100.34.217.177:999
82.134.25.6:4153
82.146.40.75:10103
181.204.39.202:26312
95.170.201.34:43018
149.62.244.24:4153
163.172.149.133:16379
210.212.39.130:8080
45.73.0.118:5678
103.153.247.33:3125
149.34.210.56:9090
2.239.213.133:3128
72.195.34.35:27360
103.169.130.36:8080
103.154.230.123:5678
180.178.98.94:2526
122.54.105.109:8082
95.128.142.76:1080
88.202.230.103:32400
77.237.28.191:8080
202.46.84.226:65437
103.92.235.60:39148
200.95.184.58:999
134.122.26.11:80
209.126.104.38:38729
161.97.165.57:58958
120.28.204.19:8082
195.169.35.214:3128
46.161.196.222:9812
178.33.252.189:3128
190.144.224.182:44550
45.229.56.64:999
180.232.171.210:8080
41.242.116.150:50003
212.112.120.252:45555
124.106.116.34:1337
69.2.15.238:8111
185.193.157.39:9121
183.88.223.211:8080
129.205.244.185:5678
185.82.238.203:5678
163.172.137.49:16379
212.110.188.202:34409
103.137.218.233:83
148.230.206.229:8080
173.255.119.18:80
103.35.189.217:3128
95.31.42.199:3629
83.169.17.201:80
199.116.114.11:4145
45.84.1.20:10086
202.131.65.110:80
162.33.179.3:80
8.219.97.248:80
103.153.142.18:8080
95.47.119.122:8080
51.145.176.250:8080
218.255.187.60:80
51.75.206.209:80
116.203.49.36:80
154.65.39.7:80
38.54.71.67:80
139.255.33.242:3128
38.242.213.247:3128
18.231.28.69:8080
122.160.30.99:80
142.171.17.12:3128
45.179.231.210:5678
114.129.2.82:8081
162.223.94.164:80
65.109.199.184:80
185.234.213.150:80
196.223.129.21:80
117.54.114.101:80
41.89.16.6:80
200.25.254.193:54240
162.223.94.166:80
216.137.184.253:80
94.23.19.184:2912
103.197.71.7:80
146.190.35.152:8000
20.247.228.80:80
103.94.52.70:3128
134.209.105.209:3128
51.254.78.223:80
176.65.240.15:80
190.103.177.131:80
158.180.68.39:3128
170.64.222.81:8000
194.182.178.90:3128
149.129.51.152:443
20.193.154.130:8888
93.171.220.229:8888
128.199.202.122:8080
116.203.28.43:80
20.205.61.143:80
35.185.196.38:3128
24.144.95.218:8000
173.213.71.7:80
159.65.77.168:8585
49.228.131.169:5000
46.4.23.245:20029
36.226.245.61:80
159.69.230.19:80
5.135.83.214:80
95.164.89.123:8888
74.48.7.43:80
20.37.207.8:8080
20.44.190.150:3129
161.35.70.249:3128
4.236.183.37:8080
20.44.189.184:3129
20.44.188.17:3129
20.204.212.76:3129
20.219.183.188:3129
2.47.51.18:8080
51.15.133.214:16379
188.165.226.128:59307
41.216.232.213:4153
77.242.132.113:5678
137.184.6.203:8081
200.108.50.254:4145
194.31.79.75:2195
203.161.63.60:57028
209.142.64.219:39789
160.72.98.165:3128
194.61.24.198:1080
173.249.33.122:18461
122.155.165.191:3128
172.104.154.229:51383
103.234.27.78:9990
51.15.247.93:16379
64.202.186.2:40335
40.74.220.214:3128
139.255.45.67:5678
196.29.231.1:4145
51.81.42.255:3129
202.69.38.42:5678
182.253.37.83:443
162.214.102.121:8404
184.181.217.206:4145
212.110.188.198:34405
185.161.186.83:54321
46.209.100.252:5678
213.136.78.200:45380
200.119.218.89:999
79.142.82.244:3629
72.195.34.41:4145
103.121.42.13:5678
92.204.134.38:56177
41.33.203.233:1975
103.156.74.154:8199
14.232.166.150:5678
103.165.155.165:1111
139.180.168.182:80
180.180.124.248:49992
116.50.174.219:8080
114.79.148.218:80
46.173.35.229:3629
92.205.60.110:55177
92.42.8.21:4145
219.65.42.167:80
103.181.168.218:8080
103.13.204.24:8082
43.226.14.141:32650
103.171.244.64:8080
103.26.129.18:8080
92.205.61.38:47914
167.172.96.213:80
85.113.7.142:5678
103.107.84.124:8080
186.224.225.82:42648
185.139.56.133:6961
38.188.166.4:999
138.201.182.222:80
103.59.44.33:2022
107.155.65.11:3128
188.165.223.112:7739
51.158.125.135:16379
159.223.71.71:58684
45.11.95.166:6005
103.250.130.110:8080
45.178.133.77:999
72.195.114.169:4145
184.178.172.26:4145
211.234.125.5:443
116.99.235.172:30230
128.199.165.63:56001
68.183.143.134:80
190.110.226.162:80
116.118.98.26:5678
138.197.102.119:80
103.155.196.27:8080
51.158.78.200:16379
95.80.89.90:1080
168.181.81.225:9090
93.188.161.84:80
103.193.144.76:8181
94.131.14.66:3128
208.67.28.28:58090
178.213.24.233:8080
117.54.114.35:80
195.35.32.249:80
114.223.8.84:8118
41.65.236.39:1981
82.165.198.169:1245
66.70.238.78:7777
181.176.160.30:999
177.136.86.5:999
212.110.188.189:34405
193.122.197.154:80
103.181.177.41:5678
45.143.108.114:8080
202.51.68.205:80
103.172.70.191:8181
188.166.56.246:80
181.209.100.50:999
212.156.217.147:4153
198.74.51.79:8888
103.170.115.213:2020
176.113.157.149:37417
79.137.194.110:80
181.196.254.201:999
95.111.238.142:3128
37.26.86.206:47464
82.64.77.30:80
162.19.7.57:46199
184.178.172.11:4145
195.158.18.236:3128
152.230.215.123:80
80.65.28.57:30924
47.236.85.113:443
12.176.231.147:80
43.134.229.36:4000
110.34.3.229:3128
51.15.242.202:8888
45.87.43.152:80
51.255.20.138:80
91.107.180.250:80
133.18.234.13:80
213.233.177.134:80
173.213.71.6:80
51.89.14.70:80
194.182.187.78:3128
92.119.59.161:80
77.68.49.253:80
13.81.217.201:80
136.243.89.93:8888
20.219.235.172:3129
202.86.138.18:8080
185.199.53.73:80
5.45.110.13:80
20.219.176.57:3129
20.219.182.59:3129
122.252.179.66:5678
80.76.43.203:1080
50.96.204.8:18351
208.109.13.24:35134
51.89.21.99:56154
51.158.64.130:16379
183.80.130.10:4145
31.200.242.201:15755
82.180.139.155:80
186.10.102.218:5678
83.218.186.22:5678
177.136.124.36:3629
43.248.25.6:4145
209.222.97.30:38486
61.247.25.231:4145
165.227.104.122:58839
36.91.233.114:5678
198.12.253.239:4368
89.116.191.51:80
50.63.12.33:23977
88.84.62.5:4153
115.69.214.68:5678
103.198.26.20:1234
192.64.115.141:2014
143.137.116.72:1080
103.133.222.170:443
45.238.57.1:3629
93.175.194.154:3629
80.90.188.187:24530
172.93.111.87:12805
162.0.220.222:13166
177.93.77.10:4153
159.89.194.121:62108
103.114.96.125:8291
213.165.185.211:4153
103.220.205.162:4673
132.148.245.169:38780
128.199.221.91:7176
27.123.3.139:4145
188.165.252.198:5132
103.182.52.159:5678
23.94.51.30:3128
186.215.87.194:6005
37.130.26.102:8081
185.220.86.47:5678
110.139.128.232:4145
173.212.223.23:47570
65.49.82.7:58195
45.174.57.66:999
202.137.24.19:7890
162.0.220.217:46789
103.127.63.57:5678
163.172.147.89:16379
188.124.15.13:3629
103.113.71.230:3128
37.228.65.107:51032
112.202.238.99:8082
103.174.178.129:2016
190.96.97.202:4153
159.223.71.71:64151
91.192.25.158:4145
173.249.7.118:2276
36.111.191.127:808
206.81.14.168:31966
103.178.42.3:8181
161.97.170.209:43514
103.115.227.21:80
142.11.195.185:80
64.23.153.213:443
191.97.6.150:999
119.235.219.50:8080
103.78.25.99:5678
157.254.28.10:999
161.49.176.173:1337
107.180.90.42:10670
123.231.143.197:9898
88.119.139.237:53281
187.86.133.125:3128
186.248.87.172:5678
129.222.176.138:999
162.240.72.139:40415
69.167.169.46:40468
77.238.79.111:5678
36.95.84.151:41890
83.167.24.13:8080
31.211.130.237:8192
180.191.23.9:8082
212.193.56.27:80
197.243.20.187:80
58.65.197.91:8080
155.93.96.210:8080
165.16.27.43:1981
201.251.63.208:49271
103.157.83.77:8080
112.198.194.16:8383
103.121.195.12:61221
200.108.190.99:9800
182.93.69.74:5678
103.153.62.158:3125
212.126.96.154:8080
103.167.69.90:8080
34.87.84.105:80
103.76.149.102:8181
184.178.172.17:4145
41.203.83.66:8080
193.105.123.194:8123
103.109.57.226:5566
103.215.16.38:8080
182.253.40.55:4153
23.254.231.55:80
138.84.40.117:999
95.216.57.120:8292
38.156.75.130:8080
194.163.183.151:8899
45.239.30.1:999
103.78.96.146:80
185.112.146.227:8080
182.253.69.95:8080
112.78.131.6:8080
136.233.80.157:4480
45.119.9.158:808
103.148.39.26:82
162.216.204.146:1080
103.178.194.123:1111
45.6.224.76:999
5.34.46.94:8080
103.17.90.6:5678
103.170.115.180:8080
187.44.211.118:4153
47.243.177.210:8088
34.135.203.172:3128
103.165.128.171:8080
103.149.194.61:32650
183.89.9.82:8080
46.219.80.142:57401
38.156.74.87:8080
103.75.85.115:1111
188.64.113.104:1080
5.78.65.91:80
24.144.87.187:8000
103.174.175.99:8085
36.37.251.171:5678
202.154.18.10:8080
177.19.167.242:80
202.150.151.138:4995
79.132.132.114:3128
222.127.139.2:80
37.230.144.251:8118
164.77.240.26:999
217.26.191.75:999
200.10.150.115:80
146.56.154.83:21000
52.172.1.186:3128
66.225.246.238:8080
203.74.125.18:8888
62.33.207.202:3128
128.140.26.12:80
188.166.17.18:8881
47.56.110.204:8989
24.121.173.151:3128
185.247.18.200:8888
190.136.36.37:80
198.44.255.5:80
123.30.154.171:7777
47.242.47.64:8888
78.135.87.95:80
80.240.130.161:8888
5.75.200.38:80
51.12.208.66:80
142.44.210.174:80
5.75.198.86:80
158.69.53.98:9300
156.232.9.194:8080
188.34.179.101:80
"""
proxies = proxy_list.strip().split('\n')
working_proxies = None  # Define a global variable to store working proxies


async def test_proxy(proxy):
    try:
        async with aiohttp.ClientSession() as session:
            async with session.get('https://www.example.com', proxy=f'http://{proxy}', timeout=10) as response:
                if response.status == 200:
                    return True
    except Exception as e:
        pass
    return False


async def get_working_proxies(proxies):
    random_proxies = random.sample(proxies, 50)  # Select random 20 proxies
    working_proxies = []
    tasks = []
    for proxy in random_proxies:
        task = asyncio.create_task(test_proxy(proxy))
        tasks.append(task)
    results = await asyncio.gather(*tasks)
    for proxy, result in zip(random_proxies, results):
        if result:
            working_proxies.append(proxy)
    return working_proxies


async def main():
    global working_proxies
    working_proxies = await get_working_proxies(proxies)
    if working_proxies:
        print(f'Using working proxies: {working_proxies}')
    else:
        print('No working proxy found')


@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        profile_name = request.form['profile_name']
        percentage = float(request.form['percentage'])

        try:
            download_dir = f'{profile_name}_downloads'
            os.makedirs(download_dir, exist_ok=True)

            # Use the working proxy here
            proxy = random.choice(working_proxies) if working_proxies else None
            proxies = {'http': f'http://{proxy}', 'https': f'http://{proxy}'} if proxy else None
            asyncio.run(download_posts(profile_name, percentage, download_dir, proxies))

            # Create a zip file
            zip_file_path = f'{download_dir}.zip'
            with zipfile.ZipFile(zip_file_path, 'w') as zipf:
                for root, dirs, files in os.walk(download_dir):
                    for file in files:
                        zipf.write(os.path.join(root, file),
                                   arcname=os.path.relpath(os.path.join(root, file), download_dir))

            # Remove the downloaded directory
            shutil.rmtree(download_dir)

            return render_template('download.html', zip_file_path=zip_file_path)
        except Exception as e:
            error_message = str(e)
            return render_template('index.html', error_message=error_message)

    return render_template('index.html')


def download_post_with_retry(post, target_dir, proxies, max_retries=3):
    for _ in range(max_retries):
        try:
            L = Instaloader()
            L.download_post(post, target=target_dir)
            return True
        except requests.HTTPError as e:
            if e.response.status_code == 401:
                print(f"HTTP Error 401: Unauthorized. Retrying...")
                asyncio.sleep(1)  # Wait for a short time before retrying
                continue  # Retry
            else:
                raise e
    return False


async def download_posts(profile_name, percentage, target_dir, proxies):
    L = Instaloader()

    profile = Profile.from_username(L.context, profile_name)
    posts_sorted_by_likes = sorted(profile.get_posts(),
                                   key=lambda p: p.likes + p.comments,
                                   reverse=True)

    for post in islice(posts_sorted_by_likes, ceil(profile.mediacount * percentage / 100)):
        download_success = download_post_with_retry(post, target_dir, proxies)
        if not download_success:
            raise Exception("Failed to download post after retries.")

    return target_dir


@app.route('/download/<path:zip_file_path>')
def download(zip_file_path):
    return send_file(zip_file_path, as_attachment=True)


if __name__ == '__main__':
    asyncio.run(main())
    app.run(debug=True)
